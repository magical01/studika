export default class e{constructor(){this._useCache=!0,this._localStorageRegion="user-region",this._localStorageBookmarks="user-region-bookmarks",this._cssClassNameHidden="visually-hidden",this._preloaderElement=document.querySelector(".lds-ellipsis"),this._selectedRegionElement=document.querySelector(".custom-select__text"),this._bookmarksElement=document.querySelector(".dropdown__selected"),this._regionListElement=document.querySelector(".custom-select__dropdown ul"),this._inputField=document.querySelector(".dropdown__search .dropdown__input"),this._inputEraser=document.querySelector(".dropdown__search .dropdown__search-icon"),this._saveRegionBtn=document.querySelector(".dropdown__save"),this._api="https://studika.ru/api/areas",this._saveRegionBtn.addEventListener("click",()=>{this.saveUserRegion()}),this._inputField.addEventListener("input",()=>{this.renderRegionList()}),this._inputEraser.addEventListener("click",()=>{this.resetSearchField(),this.renderRegionList(),this.hideIcon()}),this._regionDataCached=[],this.showPreloader(),this.loadRegion(),this.loadRegionBookmarks(),this.renderRegionBookmarks()}showPreloader(){this._bookmarksElement.classList.add(this._cssClassNameHidden),this._preloaderElement.classList.remove(this._cssClassNameHidden)}hidePreloader(){this._bookmarksElement.classList.remove(this._cssClassNameHidden),this._preloaderElement.classList.add(this._cssClassNameHidden)}resetSearchField(){this._inputField.value=""}hideIcon(){this._inputEraser.classList.remove("visible")}addRegionToBookmarks(e){this._bookmarks.push(e),this.saveRegionBookmarks(),this.renderRegionBookmarks()}removeRegionFromBookmarks(e){let t=e.hasOwnProperty("state_id"),i=-1;for(let[s,o]of this._bookmarks.entries())if(t){if(o.id==e.id&&o?.state_id==e.state_id){i=s;break}}else if(o.id==e.id){i=s;break}i>=0&&this._bookmarks.splice(i,1),this.saveRegionBookmarks(),this.renderRegionBookmarks()}saveRegionBookmarks(){let e=JSON.stringify(this._bookmarks);localStorage.setItem(this._localStorageBookmarks,e)}loadRegionBookmarks(){let e=localStorage.getItem(this._localStorageBookmarks),t=[];if(null!==e)try{t=JSON.parse(e)}catch(i){localStorage.removeItem(this._localStorageBookmarks)}this._bookmarks=t}getRegionBookmarksItemHTML(e,t,i){return`
      <div class="dropdown__selected-city" role="button" data-id="${t}">
        ${e}
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" >
          <path
            d="M14 1.41L12.59 0L7 5.59L1.41 0L0 1.41L5.59 7L0 12.59L1.41 14L7 8.41L12.59 14L14 12.59L8.41 7L14 1.41Z"
            fill="white"
          />
        </svg>
      </div>
    `}renderRegionBookmarks(){let e="";for(let t of this._bookmarks){let i=t.hasOwnProperty("state_id"),s=i?String(t.state_id)+"__"+String(t.id):String(t.id);e+=this.getRegionBookmarksItemHTML(t.name,s),setTimeout(()=>{document.querySelector(`.dropdown__selected-city[data-id="${s}"] svg`).addEventListener("click",()=>{this.removeRegionFromBookmarks(t)})},10)}this._bookmarksElement.innerHTML=e}getDefaultRegion(){return{name:"Любой город",id:-1,type:"default"}}loadRegion(){let e=localStorage.getItem(this._localStorageRegion),t=this.getDefaultRegion();if(null!==e)try{t=JSON.parse(e)}catch(i){localStorage.removeItem(this._localStorageRegion)}this._selectedRegionElement.textContent=t.name}saveRegion(e){let t=JSON.stringify(e);localStorage.setItem(this._localStorageRegion,t)}saveUserRegion(){let e=[...this._bookmarks].pop();this.saveRegion(e),this.showPreloader(),setTimeout(()=>{document.location.reload(!0)},500)}selectRegionAddEvent(e,t){setTimeout(()=>{let i=document.querySelector(`.dropdown__item[data-id="${t}"]`);i&&i.addEventListener("click",()=>{this.addRegionToBookmarks(e)})},100)}getRegionElementHTML(e,t){return`
      <li class="dropdown__item">${e}</li>
    `}getCityElementHTML(e,t,i){return`
      <li class="dropdown__item" data-id="${i}">${e}
        <span class="dropdown__item-region">${t}</span>
      </li>
    `}formatStr(e,t){if(0==t.length)return{formattedString:e,isIncludes:!0};let i=e.toLowerCase().indexOf(t.trim().toLowerCase());if(i<0)return{formattedString:e,isIncludes:!1};{let s=i+t.trim().length;return{formattedString:e.substring(0,i)+"<b>"+e.substring(i,s)+"</b>"+e.substring(s,e.length),isIncludes:!0}}}renderRegionList(e){void 0===e&&(e=this._regionDataCached);let t=this._inputField.value,i="";for(let s of e)if("area"==s.type){let{formattedString:o,isIncludes:r}=this.formatStr(s.name,t);for(let a of(r&&(i+=this.getRegionElementHTML(o,s.id),this.selectRegionAddEvent(s,s.id)),s.cities)){let{formattedString:n,isIncludes:d}=this.formatStr(a.name,t);d&&(i+=this.getCityElementHTML(n,s.name,String(a.state_id)+"_"+String(a.id)),this.selectRegionAddEvent(a,String(a.state_id)+"_"+String(a.id)))}}this._regionListElement.innerHTML=i}fetchRegionList(){if(!0===this._useCache&&this._regionDataCached.length>0){this.renderRegionList();return}this.showPreloader(),fetch(this._api,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{this.hidePreloader(),this._regionDataCached=e,this.renderRegionList()})}};